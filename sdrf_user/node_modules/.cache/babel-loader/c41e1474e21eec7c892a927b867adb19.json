{"ast":null,"code":"import _slicedToArray from \"/home/n3op2/node/sdrf_client/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nvar _jsxFileName = \"/home/n3op2/node/sdrf_client/src/App.js\";\nimport React, { Fragment, useEffect, useState } from 'react';\nimport * as d3 from 'd3';\nimport axios from 'axios';\nconst url = 'http://localhost:3010';\nconst reader = new FileReader(); // D3 screen\n\nconst svg = d3.select('.chart').attr('width', width + margin.left + margin.right).attr('height', height + margin.top + margin.bottom).append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');\n\nconst Heatmap = () => {\n  // TODO merge/review containers...\n  const _useState = useState([]),\n        _useState2 = _slicedToArray(_useState, 2),\n        samples = _useState2[0],\n        setSamples = _useState2[1];\n\n  const _useState3 = useState([]),\n        _useState4 = _slicedToArray(_useState3, 2),\n        d3data = _useState4[0],\n        setD3Data = _useState4[1];\n\n  const _useState5 = useState(),\n        _useState6 = _slicedToArray(_useState5, 2),\n        decodedFreqs = _useState6[0],\n        setDecodedFreqs = _useState6[1]; // Blob to string\n  // D3 stuff \n\n\n  const margin = {\n    top: 100,\n    right: 50,\n    bottom: 100,\n    left: 50\n  };\n  const width = 9450 - margin.left - margin.right;\n  const height = 1250 - margin.top - margin.bottom;\n\n  const freqsMapper = (data, hzLow, hzHigh, createdAt) => {\n    const step = (hzHigh - hzLow) / data.freqs.length;\n    let hz = hzLow;\n    const tmpArray = [];\n    return data.freqs.map(db => {\n      const tmpObj = {};\n      tmpObj.createdAt = createdAt;\n      tmpObj.db = db;\n      tmpObj.hz = hz;\n      hz = Math.round(hz + step);\n      tmpArray.push(tmpObj);\n      return tmpObj;\n    });\n  }; // FileReader 'onload' event\n\n\n  reader.onload = (s => {\n    return e => {\n      console.log('s: ', s);\n      const data = JSON.parse(e.target.result);\n\n      if (data) {\n        const hzLow = data.hzLow,\n              hzHigh = data.hzHigh,\n              createdAt = data.createdAt;\n        const newLine = freqsMapper(data, hzLow, hzHigh, createdAt);\n        let tmpArr = [...s];\n        tmpArr.unshift(newLine);\n        tmpArr.pop();\n        setSamples(tmpArr);\n      }\n    };\n  })(samples); // Pull data from the server and store it in the state\n\n\n  const getData = async () => {\n    const res = await axios.get(url);\n    console.log('server response: ', res.data);\n    const data = res.data;\n    const baseHz = res.data[0].hzLow;\n    const topHz = res.data[0].hzHigh;\n    const step = (topHz - baseHz) / res.data[0].freqs.length;\n    let hz = baseHz;\n    const dataVis = []; // TODO setSamples(map...)\n\n    const mappedData = data.map((el, i) => {\n      hz = baseHz;\n      return el.freqs.map(db => {\n        const tmp = {};\n        tmp.createdAt = el.createdAt;\n        tmp.db = db;\n        tmp.hz = hz;\n        hz = Math.round(hz + step);\n        dataVis.push(tmp);\n        return tmp;\n      });\n    }); // update state\n\n    setD3Data([...dataVis]);\n    setSamples([...mappedData]);\n    await new Promise(r => setTimeout(r, 3000));\n    return new Promise(resolve => {\n      if (mappedData) return resolve(mappedData);\n      resolve('mappedData -> undefined');\n    });\n  };\n\n  useEffect(() => {\n    const wsClient = new WebSocket('ws://localhost:8080');\n\n    wsClient.onopen = () => onConnection();\n\n    wsClient.onmessage = msg => handleMessage(msg);\n\n    wsClient.onclose = e => console.log('closing ws connection... ', e);\n\n    getData().then(data => {\n      // X d3 scale\n      const xScale = d3.scaleBand().range([0, width]).domain(data[0].map(d => {\n        return d.hz;\n      })).padding(0.01); // Y d3 scale\n\n      const yScale = d3.scaleBand().range([height, 0]).domain(data.map(el => el.map(item => item.createdAt).filter((v, i, a) => a.indexOf(v) === i)[0])).padding(0.01);\n    });\n    return () => {\n      console.log('unmounting...');\n    };\n  }, []); // websocket event handlers\n  // ===================================================================\n\n  const handleMessage = msg => {\n    console.log('msg received: ', msg.data);\n    reader.readAsText(msg.data);\n  };\n\n  const onConnection = () => {\n    console.log('websocket: connected');\n  };\n\n  console.log('re-rendering: ', samples.length);\n\n  if (samples.length > 0) {\n    // d3 stuff\n\n    /*\n    const svg = d3.select('.chart')\n      .attr('width', width + margin.left + margin.right)\n      .attr('height', height + margin.top + margin.bottom)\n      .append('g')\n      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');\n    */\n    svg.append('g').attr('transform', 'translate(0,' + height + ')').call(d3.axisBottom(xScale).ticks(30, 's')).attr('class', 'xAxis');\n    svg.append(\"g\").call(d3.axisLeft(yScale)).attr('class', 'yAxis');\n    /* not needed for now...\n    svg.append('text')\n      .attr('transform','translate(' + (width / 2) + ',' + (height + 40) + ')')\n      .style('text-anchor','middle')\n      .text('HZ');\n    */\n\n    const colorScale = d3.scaleLinear().range(['blue', 'yellow', 'red']).domain([-40, 0, 40]);\n    svg.selectAll('g.x text').attr('transform', 'translate(-10,10) rotate(315)');\n    svg.selectAll().data(d3data).enter().append(\"rect\").attr(\"x\", function (d) {\n      return xScale(d.hz);\n    }).attr(\"y\", function (d) {\n      return yScale(d.createdAt);\n    }).attr(\"width\", xScale.bandwidth()).attr(\"height\", yScale.bandwidth()).style(\"fill\", function (d) {\n      return colorScale(d.db);\n    });\n    svg.selectAll('g.x').attr('transform', 'translate(-10,10) rotate(315)');\n  }\n\n  ; // Testing... to remove\n\n  const renderHeatmap = () => {\n    const svg = d3.select('.chart').attr('width', width + margin.left + margin.right).attr('height', height + margin.top + margin.bottom).append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');\n  };\n\n  return React.createElement(Fragment, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 201\n    },\n    __self: this\n  }, renderHeatmap());\n};\n\nconst Main = () => {\n  const _useState7 = useState(false),\n        _useState8 = _slicedToArray(_useState7, 2),\n        close = _useState8[0],\n        setClose = _useState8[1];\n\n  const handleClose = e => {\n    setClose(close ? false : true);\n    console.log('closing connection');\n  };\n\n  return React.createElement(Fragment, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 216\n    },\n    __self: this\n  }, React.createElement(\"button\", {\n    onClick: handleClose,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 217\n    },\n    __self: this\n  }, \"close\"), React.createElement(\"svg\", {\n    className: \"chart\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 218\n    },\n    __self: this\n  }), close ? null : React.createElement(Heatmap, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 219\n    },\n    __self: this\n  }));\n};\n\nconst App = () => {\n  return React.createElement(\"div\", {\n    style: {\n      height: '100%'\n    },\n    className: \"App\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 226\n    },\n    __self: this\n  }, React.createElement(Main, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 227\n    },\n    __self: this\n  }));\n};\n\nexport default App;","map":{"version":3,"sources":["/home/n3op2/node/sdrf_client/src/App.js"],"names":["React","Fragment","useEffect","useState","d3","axios","url","reader","FileReader","svg","select","attr","width","margin","left","right","height","top","bottom","append","Heatmap","samples","setSamples","d3data","setD3Data","decodedFreqs","setDecodedFreqs","freqsMapper","data","hzLow","hzHigh","createdAt","step","freqs","length","hz","tmpArray","map","db","tmpObj","Math","round","push","onload","s","e","console","log","JSON","parse","target","result","newLine","tmpArr","unshift","pop","getData","res","get","baseHz","topHz","dataVis","mappedData","el","i","tmp","Promise","r","setTimeout","resolve","wsClient","WebSocket","onopen","onConnection","onmessage","msg","handleMessage","onclose","then","xScale","scaleBand","range","domain","d","padding","yScale","item","filter","v","a","indexOf","readAsText","call","axisBottom","ticks","axisLeft","colorScale","scaleLinear","selectAll","enter","bandwidth","style","renderHeatmap","Main","close","setClose","handleClose","App"],"mappings":"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","sourcesContent":["import React, { Fragment, useEffect, useState } from 'react';\nimport * as d3 from 'd3';\nimport axios from 'axios';\n\nconst url = 'http://localhost:3010';\nconst reader = new FileReader();\n// D3 screen\nconst svg = d3.select('.chart')\n  .attr('width', width + margin.left + margin.right)\n  .attr('height', height + margin.top + margin.bottom)\n  .append('g')\n  .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');\n\nconst Heatmap = () => {\n  // TODO merge/review containers...\n  const [samples, setSamples] = useState([]);\n  const [d3data, setD3Data] = useState([]);\n  const [decodedFreqs, setDecodedFreqs] = useState();\n\n  // Blob to string\n\n  // D3 stuff \n  const margin = {top: 100, right: 50, bottom: 100, left: 50};\n  const width = 9450 - margin.left - margin.right;\n  const height = 1250 - margin.top - margin.bottom;\n\n  const freqsMapper = (data, hzLow, hzHigh, createdAt) => {\n    const step = (hzHigh - hzLow) / data.freqs.length;\n    let hz = hzLow;\n    const tmpArray = [];\n\n    return data.freqs.map((db) => {\n      const tmpObj = {};\n      tmpObj.createdAt = createdAt;\n      tmpObj.db = db;      \n      tmpObj.hz = hz;\n      hz = Math.round(hz + step);\n      tmpArray.push(tmpObj);\n      return tmpObj;\n    });\n  };\n\n  // FileReader 'onload' event\n  reader.onload = ((s) => {\n    return (e) => {\n      console.log('s: ', s)\n      const data = JSON.parse(e.target.result);\n    \n      if (data) {\n        const { hzLow, hzHigh, createdAt } = data\n        const newLine = freqsMapper(data, hzLow, hzHigh, createdAt);\n        let tmpArr = [...s];\n        tmpArr.unshift(newLine);\n        tmpArr.pop();\n        setSamples(tmpArr);\n      }\n    }\n  })(samples)\n\n  // Pull data from the server and store it in the state\n  const getData = async () => {\n    const res = await axios.get(url);\n    console.log('server response: ', res.data);\n    const data = res.data;\n    const baseHz = res.data[0].hzLow;\n    const topHz = res.data[0].hzHigh;\n    const step = (topHz - baseHz) / res.data[0].freqs.length;\n    let hz = baseHz;\n    const dataVis = [];\n\n    // TODO setSamples(map...)\n    const mappedData = data.map((el, i) => {\n      hz = baseHz;\n      return el.freqs.map((db) => {\n        const tmp = {};\n        tmp.createdAt = el.createdAt;\n        tmp.db = db;\n        tmp.hz = hz;\n        hz = Math.round(hz + step);\n        dataVis.push(tmp);\n        return tmp;\n      });\n    });\n\n    // update state\n    setD3Data([...dataVis])\n    setSamples([...mappedData]);\n  \n    await new Promise((r) => setTimeout(r, 3000));\n\n    return new Promise((resolve) => {\n      if (mappedData) return resolve(mappedData);\n      resolve('mappedData -> undefined')\n    });\n  };\n\n  useEffect(() => {\n    const wsClient = new WebSocket('ws://localhost:8080');\n\n    wsClient.onopen = () => onConnection(); \n    wsClient.onmessage = (msg) => handleMessage(msg);\n    wsClient.onclose = (e) => console.log('closing ws connection... ', e);\n\n    getData().then((data) => {\n      // X d3 scale\n      const xScale = d3.scaleBand()\n        .range([0, width])\n        .domain(data[0].map(d => {\n          return d.hz;\n        }))\n        .padding(0.01);\n\n      // Y d3 scale\n      const yScale = d3.scaleBand()\n        .range([ height, 0 ])\n        .domain(data.map((el) => el.map((item) => item.createdAt)\n          .filter((v, i, a) => a.indexOf(v) === i)[0]))\n        .padding(0.01);\n    });\n\n    return () => {\n      console.log('unmounting...');\n    }\n  }, []);\n\n  // websocket event handlers\n  // ===================================================================\n  const handleMessage = (msg) => {\n    console.log('msg received: ', msg.data);\n    reader.readAsText(msg.data);\n  };\n\n  const onConnection = () => {\n    console.log('websocket: connected');\n  };\n\n  console.log('re-rendering: ', samples.length)\n\n  if (samples.length > 0) {\n    // d3 stuff\n    /*\n    const svg = d3.select('.chart')\n      .attr('width', width + margin.left + margin.right)\n      .attr('height', height + margin.top + margin.bottom)\n      .append('g')\n      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');\n    */\n\n    svg.append('g')\n      .attr('transform', 'translate(0,' + height + ')')\n      .call(d3.axisBottom(xScale)\n        .ticks(30, 's'))\n      .attr('class','xAxis');\n\n    svg.append(\"g\")\n      .call(d3.axisLeft(yScale))\n      .attr('class','yAxis');\n\n    /* not needed for now...\n    svg.append('text')\n      .attr('transform','translate(' + (width / 2) + ',' + (height + 40) + ')')\n      .style('text-anchor','middle')\n      .text('HZ');\n    */\n\n    const colorScale = d3.scaleLinear()\n      .range(['blue', 'yellow', 'red'])\n      .domain([-40, 0, 40]);\n\n    svg.selectAll('g.x text')\n      .attr('transform', 'translate(-10,10) rotate(315)');\n\n    svg.selectAll()\n        .data(d3data)\n        .enter()\n        .append(\"rect\")\n        .attr(\"x\", function(d) {\n          return xScale(d.hz)\n        })\n        .attr(\"y\", function(d) {\n          return yScale(d.createdAt)\n        })\n        .attr(\"width\", xScale.bandwidth() )\n        .attr(\"height\", yScale.bandwidth() )\n        .style(\"fill\", function(d) { return colorScale(d.db)} )\n\n    svg.selectAll('g.x')\n      .attr('transform', 'translate(-10,10) rotate(315)');\n  };\n\n  // Testing... to remove\n  const renderHeatmap = () => {\n    const svg = d3.select('.chart')\n      .attr('width', width + margin.left + margin.right)\n      .attr('height', height + margin.top + margin.bottom)\n      .append('g')\n      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');\n  };\n\n  return (\n    <Fragment>\n      {renderHeatmap()}\n    </Fragment>\n  );\n};\n\nconst Main = () => {\n  const [close, setClose] = useState(false);\n\n  const handleClose = (e) => {\n    setClose(close ? false : true);\n    console.log('closing connection');\n  };\n\n  return (\n    <Fragment>\n      <button onClick={handleClose}>close</button>\n      <svg className='chart'></svg>\n      {close ? null : <Heatmap />} \n    </Fragment>\n  );\n}\n\nconst App = () => {\n  return (\n    <div style={{height: '100%'}} className=\"App\">\n      <Main />\n    </div>\n  );\n};\n\nexport default App;\n"]},"metadata":{},"sourceType":"module"}